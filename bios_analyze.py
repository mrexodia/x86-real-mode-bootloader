import ctypes
from bootemu import BIOSDataArea, IVT_NAMES

IVT = """
53FF00F053FF00F0C3E200F053FF00F053FF00F054FF00F053FF00F053FF00F0A5FE00F087E900F0
3DD400F03DD400F03DD400F03DD400F057EF00F03DD400F09AD200F04DF800F041F800F0FEE300F0
39E700F059F800F02EE800F0D2EF00F062D400F0F2E600F06EFE00F053FF00F053FF00F053FF00F0
7C6000F0409400C053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F0
53FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F0
53FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F0
53FF00F053FF00F053FF00F053FF00F059EC00F03D00C09F53FF00F0407200C053FF00F053FF00F0
53FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F0
53FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F0
53FF00F053FF00F053FF00F053FF00F053FF00F053FF00F000000000000000000000000000000000
00000000000000000000000053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F0
53FF00F053FF00F022D400F046D400F046D400F046D400F02BD400F034D400F019D400F046D400F0
53FF00F00000000053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F0
53FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F0
53FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F0
53FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F0
53FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F0
53FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F0
53FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F0
53FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F0
53FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F0
53FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F0
53FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F0
53FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F0
53FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F053FF00F0
53FF00F053FF00F053FF00F053FF00F053FF00F053FF00F0
"""
BDA = """
F803000000000000780300000000C09F2742007F0200000000001E001E0000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000003500000100000
00180000000000000000000000000000070600D4030000000000000095890000000000000001C000
140000000A0000001E003E0018100060F95108000000000700000000000010000000000000000000
0000000000000000A06600C000000000000000000000000000400300466700000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000
"""


ivt = bytes.fromhex(IVT.strip())
bda = BIOSDataArea.from_buffer_copy(bytes.fromhex(BDA.strip()))

assert ctypes.sizeof(bda) == 256, (
    f"Expected BIOS Data Area size 256, got {ctypes.sizeof(bda)}"
)

print("BIOS Data Area:")
for field in bda._fields_:
    field_name = field[0]
    field_value = getattr(bda, field_name)
    field_offset = getattr(BIOSDataArea, field_name).offset
    field_name = f"[+0x{field_offset:03X}] {field_name}"
    if isinstance(field_value, int):
        print(f"{field_name}: 0x{field_value:04X} ({field_value})")
    elif isinstance(field_value, ctypes.Array):
        is_null_array = all(b == 0 for b in field_value)
        if is_null_array:
            print(f"{field_name}: {bytes(field_value).hex(' ')} <null array>")
        else:
            print(f"{field_name}: {bytes(field_value).hex(' ')}")
    else:
        print(f"{field_name}: {field_value} ({type(field_value)})")

print("\nInterrupt Vector Table:")

for i in range(256):
    offset = i * 4
    name = IVT_NAMES.get(i, "<unknown>")
    entry = int.from_bytes(ivt[offset : offset + 4], "little")
    print(f"[{i:02x}]: 0x{entry:08X} -> {name}")
