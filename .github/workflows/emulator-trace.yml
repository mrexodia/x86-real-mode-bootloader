name: Bootloader Emulator Trace

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  emulate-and-trace:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/mrexodia/x86-real-mode-bootloader:latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Compile simple bootloader
      run: |
        echo "=========================================="
        echo "Compiling simple_boot.asm..."
        echo "=========================================="
        nasm -f bin simple_boot.asm -o simple_boot.bin
        ls -lh simple_boot.bin
        echo "Verifying boot signature..."
        xxd -l 512 -c 16 simple_boot.bin | tail -2

    - name: Compile IVT test bootloader
      run: |
        echo ""
        echo "=========================================="
        echo "Compiling test_ivt.asm..."
        echo "=========================================="
        nasm -f bin test_ivt.asm -o test_ivt.bin
        ls -lh test_ivt.bin
        echo "Verifying boot signature..."
        xxd -l 512 -c 16 test_ivt.bin | tail -2

    - name: Compile real FAT bootloader
      run: |
        echo ""
        echo "=========================================="
        echo "Compiling boot.c (FAT bootloader)..."
        echo "=========================================="
        make boot boot.img
        ls -lh boot boot.img
        echo "Boot sector signature:"
        xxd -l 512 -c 16 boot | tail -2
        echo "Boot image info:"
        file boot.img

    - name: Run emulator on simple bootloader
      run: |
        echo ""
        echo "=========================================="
        echo "Running Emulator on simple_boot.bin"
        echo "=========================================="
        python3 emulator.py simple_boot.bin -d 0x00

    - name: Run emulator on IVT test bootloader
      run: |
        echo ""
        echo "=========================================="
        echo "Running Emulator on test_ivt.bin"
        echo "=========================================="
        python3 emulator.py test_ivt.bin -d 0x00

    - name: Run emulator on FAT bootloader
      run: |
        echo ""
        echo "=========================================="
        echo "Running Emulator on boot.img (FAT bootloader)"
        echo "=========================================="
        python3 emulator.py boot.img -d 0x00

    - name: Upload trace artifacts
      uses: actions/upload-artifact@v4
      with:
        name: emulator-traces
        path: |
          simple_boot.bin
          test_ivt.bin
          boot.img
          *.log
        retention-days: 30
